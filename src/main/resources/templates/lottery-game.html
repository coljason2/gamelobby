<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ° æ¨‚é€éŠæˆ²å¤§å»³</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f1f3f5;
            padding: 30px;
            text-align: center;
        }

        nav {
            margin-bottom: 20px;
        }

        nav button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .view {
            display: none;
        }

        .active {
            display: block;
        }

        .bet-form {
            background: white;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .number-group {
            margin-bottom: 10px;
        }

        input[type="number"], input[type="text"] {
            width: 50px;
            padding: 5px;
            margin: 0 3px;
            text-align: center;
        }

        .timer {
            font-size: 1.2em;
            color: #007bff;
            margin: 20px 0;
        }

        .success {
            color: green;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        th {
            background: #007bff;
            color: white;
        }

        .section {
            background: white;
            padding: 20px;
            max-width: 700px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #28a745;
        }
    </style>
</head>
<body>

<h1>ğŸ° æ¨‚é€éŠæˆ²å¤§å»³</h1>

<nav>
    <button onclick="showView('bet')">ä¸‹æ³¨</button>
    <button onclick="showView('query')">æŸ¥è©¢é–‹ç</button>
    <button onclick="showView('records')">ä¸­çåå–®</button>
    <button onclick="showView('history')">æˆ‘çš„ç´€éŒ„</button>
    <button onclick="window.location.href='/lobby'">å›åˆ°å¤§å»³</button>
</nav>

<!-- ä¸‹æ³¨ç•«é¢ -->
<div id="bet" class="view active">
    <div class="timer">è·é›¢ä¸‹æ¬¡é–‹çï¼š<span id="countdown">--</span> ç§’</div>
    <div>
        <h3>æœ¬æ¬¡é–‹çè™Ÿç¢¼ï¼š <span id="last-draw-numbers">å°šç„¡è³‡æ–™</span></h3>
    </div>

    <div class="bet-form">
        <label>
            æš±ç¨±ï¼š<br>
            <input type="text" id="username" required>
        </label>

        <p>è«‹è¼¸å…¥ä¸‰çµ„è™Ÿç¢¼ï¼ˆæ¯çµ„ 3 å€‹ 1~42 çš„æ•¸å­—ï¼‰</p>

        <div class="number-group">çµ„1ï¼š
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
        </div>

        <div class="number-group">çµ„2ï¼š
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
        </div>

        <div class="number-group">çµ„3ï¼š
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
            <input type="number" min="1" max="42">
        </div>

        <button onclick="submitBet()">é€å‡ºä¸‹æ³¨</button>
        <button onclick="autoFillAllGroups()">é›»è…¦é¸è™Ÿ</button>
        <div class="success" id="success-msg"></div>
    </div>

</div>

<!-- æŸ¥è©¢ç•«é¢ -->
<div id="query" class="view">
    <div class="section">
        <h2>æŸ¥è©¢æœ€è¿‘ 10 æœŸé–‹ççµæœ</h2>
<!--        <button onclick="loadRecent()">æŸ¥è©¢</button>-->
        <table id="recent-table" style="display:none;">
            <thead>
            <tr>
                <th>æœŸæ•¸</th>
                <th>é–‹çæ™‚é–“</th>
                <th>è™Ÿç¢¼</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h2>æŸ¥è©¢æŒ‡å®šæœŸæ•¸</h2>
        <input type="number" id="issue-input" placeholder="è¼¸å…¥æœŸæ•¸">
        <button onclick="loadIssue()">æŸ¥è©¢</button>
        <div id="issue-result"></div>
    </div>
</div>

<!-- ä¸­çåå–® -->
<div id="records" class="view">
    <div class="section">
        <h2>ğŸ‰ ä¸­çåå–®ï¼ˆæœ€è¿‘ä¸€æœŸï¼‰</h2>
<!--        <button onclick="loadWinners()">è¼‰å…¥</button>-->
        <ul id="winner-list"></ul>
    </div>
</div>

<!-- æˆ‘çš„ç´€éŒ„ -->
<div id="history" class="view">
    <div class="section">
        <h2>ğŸ“œ æˆ‘çš„ä¸‹æ³¨ç´€éŒ„</h2>
        <p>æš±ç¨±ï¼š<span id="history-display-name"></span></p>
        <table id="my-bets-table" style="display:none;">
            <thead>
            <tr>
                <th>æœŸæ•¸</th>
                <th>ä¸‹æ³¨æ™‚é–“</th>
                <th>è™Ÿç¢¼</th>
                <th>ä¸­ç</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ä¸­çå½ˆçª— -->
<div id="win-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>ğŸ‰ æ­å–œä¸­çï¼</h2>
        <p>æ‚¨åœ¨æœ¬æœŸå°ä¸­è™Ÿç¢¼ï¼Œè«‹å†æ¥å†å²ï¼</p>
        <button onclick="document.getElementById('win-modal').style.display='none'">é—œé–‰</button>
    </div>
</div>

<script>
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        if (viewId === 'history') {
            autoLoadMyBets();
        }

        if (viewId === 'query') {
            loadRecent();
        }

        if (viewId === 'records') {
            loadWinners();
        }

    }

    function fetchCountdown() {
        fetch('/lotto/current-time')
            .then(res => res.json())
            .then(data => {
                document.getElementById('countdown').textContent = data.countdown;
                document.getElementById('last-draw-numbers').textContent = data.lastDrawNumbers.join(', ');
                setTimeout(fetchCountdown, 1000);
                checkIfWin(data.issue);
            });
    }

    function checkIfWin(issueNumber) {
        const username = document.getElementById('username').value.trim();
        if (!username) return;

        fetch(`/lotto/check-win?user=${encodeURIComponent(username)}&issue=${issueNumber}`)
            .then(res => res.json())
            .then(data => {
                if (data.win) {
                    document.getElementById('win-modal').style.display = 'flex';
                }
            })
            .catch(() => {
            });
    }

    fetchCountdown();

    function submitBet() {
        const username = document.getElementById('username').value.trim();
        const allInputs = document.querySelectorAll('#bet input[type="number"]');
        const bets = [];

        for (let i = 0; i < 3; i++) {
            const group = [
                parseInt(allInputs[i * 3].value),
                parseInt(allInputs[i * 3 + 1].value),
                parseInt(allInputs[i * 3 + 2].value)
            ];
            if (group.some(n => isNaN(n) || n < 1 || n > 42)) {
                alert(`çµ„${i + 1} è«‹è¼¸å…¥ 1~42 çš„æœ‰æ•ˆæ•¸å­—`);
                return;
            }
            if (new Set(group).size !== 3) {
                alert(`çµ„${i + 1} çš„æ•¸å­—ä¸å¯é‡è¤‡`);
                return;
            }
            bets.push(group);
        }

        if (!username) {
            alert("è«‹è¼¸å…¥æš±ç¨±");
            return;
        }

        fetch('/lotto/bet', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user: username, bets})
        }).then(res => {
            if (res.ok) {
                document.getElementById('success-msg').textContent = "âœ… ä¸‹æ³¨æˆåŠŸï¼";
                document.querySelectorAll(".number-group input").forEach(input => input.value = "");
            } else {
                alert("é€å‡ºå¤±æ•—");
            }
        });
    }

    function loadRecent() {
        fetch("/lotto/recent?count=10")
            .then(res => res.json())
            .then(data => {
                const table = document.getElementById("recent-table");
                const tbody = table.querySelector("tbody");
                tbody.innerHTML = "";
                data.forEach(draw => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${draw.issueNumber}</td>
                        <td>${draw.drawTime.replace("T", " ")}</td>
                        <td>${draw.numbers.join(', ')}</td>
                    `;
                    tbody.appendChild(row);
                });
                table.style.display = "table";
            });
    }

    function loadIssue() {
        const issue = document.getElementById("issue-input").value;
        if (!issue) {
            alert("è«‹è¼¸å…¥æœŸæ•¸");
            return;
        }

        fetch(`/lotto/result/${issue}`)
            .then(res => {
                if (!res.ok) throw new Error("æ‰¾ä¸åˆ°è©²æœŸè³‡æ–™");
                return res.json();
            })
            .then(data => {
                document.getElementById("issue-result").innerHTML = `
                    <p>æœŸæ•¸ï¼š${data.issueNumber}</p>
                    <p>é–‹çæ™‚é–“ï¼š${data.drawTime.replace("T", " ")}</p>
                    <p>è™Ÿç¢¼ï¼š${data.numbers.join(', ')}</p>
                `;
            })
            .catch(err => {
                document.getElementById("issue-result").innerHTML = `<p style="color:red;">${err.message}</p>`;
            });
    }

    function loadWinners() {
        fetch("/lotto/winners")
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById("winner-list");
                list.innerHTML = "";
                if (data.length === 0) {
                    list.innerHTML = "<li>æœ¬æœŸå°šç„¡ä¸­çè€…</li>";
                } else {
                    data.forEach(name => {
                        const li = document.createElement("li");
                        li.textContent = name;
                        list.appendChild(li);
                    });
                }
            });
    }

    function loadMyBets(username) {
        fetch(`/lotto/my-bets?user=${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(data => {
                const table = document.getElementById('my-bets-table');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4">ç„¡ä¸‹æ³¨ç´€éŒ„</td></tr>`;
                } else {
                    data.forEach(bet => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${bet.issueNumber}</td>
                            <td>${bet.time}</td>
                            <td>${bet.bets.map(group => group.join(',')).join(' | ')}</td>
                            <td>${bet.win ? 'âœ…' : 'âŒ'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                table.style.display = 'table';
            })
            .catch(() => {
                alert('æŸ¥è©¢å¤±æ•—');
            });
    }

    function autoFillAllGroups() {
        const groups = document.querySelectorAll(".number-group");

        groups.forEach(group => {
            const inputs = group.querySelectorAll("input[type=number]");
            const numbers = getRandomNumbers(3, 1, 42);
            numbers.forEach((num, i) => {
                if (inputs[i]) {
                    inputs[i].value = num;
                }
            });
        });
    }

    function getRandomNumbers(count, min, max) {
        const pool = [];
        for (let i = min; i <= max; i++) {
            pool.push(i);
        }
        const result = [];
        while (result.length < count && pool.length > 0) {
            const idx = Math.floor(Math.random() * pool.length);
            result.push(pool.splice(idx, 1)[0]);
        }
        return result.sort((a, b) => a - b);
    }

    function autoLoadMyBets() {
        // å¾ä¸‹æ³¨é æŠ“æš±ç¨±
        const username = document.getElementById('username').value.trim();
        if (!username) {
            document.getElementById('history-display-name').textContent = 'è«‹å…ˆåœ¨ä¸‹æ³¨é è¼¸å…¥æš±ç¨±';
            return;
        }
        document.getElementById('history-display-name').textContent = username;
        loadMyBets(username);
    }
</script>
</body>
</html>
